@{
    ViewData["Title"] = "";
}

<div class="container-fluid px-0">
    <!-- Page Header -->
    <div class="row mx-0 mb-4">
        <div class="col-12 px-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0"><i class="fas fa-history me-2"></i>Activity Logs</h3>
                <div class="d-flex gap-2">
                    <button id="refreshLogs" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button id="exportLogs" class="btn btn-success">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                    @if (ViewBag.IsAdmin)
                    {
                        <button id="clearLogs" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#clearLogsModal">
                            <i class="fas fa-trash"></i> Clear Logs
                        </button>
                    }
                    <button id="showStatistics" class="btn btn-info">
                        <i class="fas fa-chart-bar"></i> Statistics
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Dashboard (Hidden by default) -->
    <div class="row mx-0 mb-4 d-none" id="statisticsDashboard">
        <div class="col-12 px-3">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Activity Statistics</h6>
                    <button id="hideStatistics" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-times"></i> Hide
                    </button>
                </div>
                <div class="card-body">
                    <div class="row" id="statisticsContent">
                        <!-- Statistics will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="row mx-0 mb-4">
        <div class="col-12 px-3">
            <div class="card shadow">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label class="form-label">Date From</label>
                            <input type="date" id="dateFrom" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Date To</label>
                            <input type="date" id="dateTo" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">User Role</label>
                            <select id="userRoleFilter" class="form-control">
                                <option value="">All Roles</option>
                                <option value="Administrator">Administrator</option>
                                <option value="Staff">Staff</option>
                                <option value="System">System</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Action Type</label>
                            <select id="actionFilter" class="form-control">
                                <option value="">All Actions</option>
                                <option value="Login">Login</option>
                                <option value="Logout">Logout</option>
                                <option value="Add User">Add User</option>
                                <option value="Edit User">Edit User</option>
                                <option value="Toggle User Status">Toggle User Status</option>
                                <option value="Reset Password">Reset Password</option>
                                <option value="Add Senior">Add Senior</option>
                                <option value="Edit Senior">Edit Senior</option>
                                <option value="Archive Senior">Archive Senior</option>
                                <option value="Restore Senior">Restore Senior</option>
                                <option value="Export">Export</option>
                                <option value="Clear Logs">Clear Logs</option>
                                <option value="Error">Error</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Search</label>
                            <div class="input-group">
                                <input type="text" id="searchInput" class="form-control" placeholder="Search logs...">
                                <button id="searchBtn" class="btn btn-primary">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button id="clearFilters" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Logs Table -->
    <div class="row mx-0">
        <div class="col-12 px-3">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Activity Logs</h6>
                    <div class="d-flex align-items-center">
                        <div class="text-muted small me-3">
                            <span id="lastUpdated">Last updated: Just now</span>
                            <span class="ms-3" id="totalCount">Loading...</span>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                            <label class="form-check-label small" for="autoRefresh">Auto-refresh</label>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="activityLogsTable" width="100%" cellspacing="0">
                            <thead class="thead-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Time</th>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                    <th>IP Address</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody">
                                <!-- Logs will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted" id="paginationInfo"></div>
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-end mb-0" id="pagination">
                                <!-- Pagination will be generated here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Notification Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-bell text-primary me-2"></i>
                <strong class="me-auto">New Activity</strong>
                <small class="text-muted">just now</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastBody">
                <!-- Notification content will go here -->
            </div>
        </div>
    </div>
</div>

<!-- Clear Logs Modal -->
<div class="modal fade" id="clearLogsModal" tabindex="-1" aria-labelledby="clearLogsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clearLogsModalLabel">Clear Activity Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone!
                </div>
                <p>Are you sure you want to clear activity logs?</p>
                <p class="text-muted small">
                    <i class="fas fa-info-circle me-1"></i>
                    This will keep only the last 1000 records. Older logs will be permanently deleted.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmClearLogs">Clear Logs</button>
            </div>
        </div>
    </div>
</div>

<!-- Activity Details Modal -->
<div class="modal fade" id="activityDetailsModal" tabindex="-1" aria-labelledby="activityDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activityDetailsModalLabel">Activity Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="activityDetailsContent">
                <!-- Activity details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .activity-log-row {
            transition: background-color 0.3s ease;
        }
        .activity-log-row.new {
            background-color: rgba(33, 150, 243, 0.1) !important;
            animation: highlight 2s ease-out;
        }
        @@keyframes highlight {
            0% { background-color: rgba(33, 150, 243, 0.3); }
            100% { background-color: rgba(33, 150, 243, 0.1); }
        }
        .badge-admin { background-color: #dc3545; }
        .badge-staff { background-color: #17a2b8; }
        .badge-system { background-color: #6c757d; }
        .stat-card {
            border-left: 4px solid;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .activity-action {
            font-weight: 600;
        }
        .activity-details {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .toast {
            min-width: 350px;
        }
        #logsTableBody tr {
            cursor: pointer;
        }
        #logsTableBody tr:hover {
            background-color: #f8f9fa;
        }
    </style>
}

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let currentPage = 1;
        const pageSize = 50;
        let totalPages = 1;
        let filters = {
            dateFrom: '',
            dateTo: '',
            userRole: '',
            action: '',
            search: ''
        };
        let autoRefreshTimer = null;
        let connection = null;

        // Initialize when document is ready
        $(document).ready(function() {
            initializeSignalR();
            loadActivityLogs();
            setupEventListeners();
            setupAutoRefresh();
        });

        // SignalR setup
        async function initializeSignalR() {
            try {
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("/activityHub")
                    .withAutomaticReconnect()
                    .build();

                // Listen for new activities
                connection.on("ReceiveNewActivity", function (activity) {
                    console.log("New activity received:", activity);
                    addNewActivityToTable(activity);
                    showToast("New activity: " + activity.action, "info");
                });

                // Listen for log clearance
                connection.on("LogsCleared", function (count) {
                    showToast(`Cleared ${count} activity logs`, "success");
                    loadActivityLogs();
                });

                await connection.start();
                console.log("SignalR connected.");
            } catch (err) {
                console.error("SignalR connection error:", err);
                // Continue without real-time updates
            }
        }

        // Load activity logs
        async function loadActivityLogs(page = 1) {
            try {
                showLoading();
                currentPage = page;

                // Build query string
                const queryParams = new URLSearchParams({
                    page: page,
                    pageSize: pageSize
                });

                // Add filters
                if (filters.dateFrom) queryParams.append('dateFrom', filters.dateFrom);
                if (filters.dateTo) queryParams.append('dateTo', filters.dateTo);
                if (filters.userRole) queryParams.append('userRole', filters.userRole);
                if (filters.action) queryParams.append('action', filters.action);
                if (filters.search) queryParams.append('search', filters.search);

                const response = await fetch(`/ActivityLog/GetActivityLogs?${queryParams}`);
                const data = await response.json();

                if (data.success) {
                    populateTable(data.data);
                    updatePagination(data);
                    updateLastUpdated();
                } else {
                    showError(data.message || "Failed to load logs");
                }
            } catch (error) {
                console.error("Error loading logs:", error);
                showError("Failed to load activity logs");
            } finally {
                hideLoading();
            }
        }

        // Populate table with data
        function populateTable(logs) {
            const tbody = $('#logsTableBody');
            tbody.empty();

            if (logs.length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="8" class="text-center py-4 text-muted">
                            <i class="fas fa-info-circle fa-2x mb-3"></i>
                            <p>No activity logs found</p>
                        </td>
                    </tr>
                `);
                return;
            }

            logs.forEach(log => {
                const row = `
                    <tr class="activity-log-row" data-id="${log.id}">
                        <td>${log.id}</td>
                        <td>
                            <div class="small">${formatDateTime(log.createdAt)}</div>
                            <small class="text-muted">${formatTimeAgo(log.createdAt)}</small>
                        </td>
                        <td>
                            <div class="fw-bold">${escapeHtml(log.userName)}</div>
                        </td>
                        <td>
                            <span class="badge ${getRoleBadgeClass(log.userRole)}">
                                ${log.userRole}
                            </span>
                        </td>
                        <td>
                            <span class="activity-action ${getActionColorClass(log.action)}">
                                ${escapeHtml(log.action)}
                            </span>
                        </td>
                        <td>
                            <div class="activity-details" title="${escapeHtml(log.details)}">
                                ${escapeHtml(log.details || 'N/A')}
                            </div>
                        </td>
                        <td>
                            <code class="text-muted small">${log.ipAddress || 'N/A'}</code>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-info view-details" title="View Details" onclick="showActivityDetails(${JSON.stringify(log).replace(/"/g, '&quot;')})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        // Add new activity to table (real-time)
        function addNewActivityToTable(activity) {
            const tbody = $('#logsTableBody');

            // If we're on page 1, add to top
            if (currentPage === 1) {
                const row = `
                    <tr class="activity-log-row new" data-id="${activity.id || 'New'}">
                        <td>${activity.id || 'New'}</td>
                        <td>
                            <div class="small">${formatDateTime(activity.createdAt)}</div>
                            <small class="text-muted">Just now</small>
                        </td>
                        <td>
                            <div class="fw-bold">${escapeHtml(activity.userName)}</div>
                        </td>
                        <td>
                            <span class="badge ${getRoleBadgeClass(activity.userRole)}">
                                ${activity.userRole}
                            </span>
                        </td>
                        <td>
                            <span class="activity-action ${getActionColorClass(activity.action)}">
                                ${escapeHtml(activity.action)}
                            </span>
                        </td>
                        <td>
                            <div class="activity-details" title="${escapeHtml(activity.details)}">
                                ${escapeHtml(activity.details || 'N/A')}
                            </div>
                        </td>
                        <td>
                            <code class="text-muted small">${activity.ipAddress || 'N/A'}</code>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-info view-details" title="View Details" onclick="showActivityDetails(${JSON.stringify(activity).replace(/"/g, '&quot;')})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;

                // Add to top of table
                tbody.prepend(row);

                // Remove highlight after 2 seconds
                setTimeout(() => {
                    $('.activity-log-row.new').removeClass('new');
                }, 2000);

                // Update count
                const currentCount = parseInt($('#totalCount').text().match(/\d+/)?.[0] || 0);
                updateCount(currentCount + 1);

                // If table is full, remove last row
                if (tbody.children().length > pageSize) {
                    tbody.children().last().remove();
                }
            }
        }

        // Show activity details modal
        function showActivityDetails(activity) {
            const modal = $('#activityDetailsModal');
            const content = $('#activityDetailsContent');

            const detailsHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Activity Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <th>ID:</th>
                                <td>${activity.id || 'N/A'}</td>
                            </tr>
                            <tr>
                                <th>Action:</th>
                                <td><span class="badge ${getActionColorClass(activity.action)}">${escapeHtml(activity.action)}</span></td>
                            </tr>
                            <tr>
                                <th>Timestamp:</th>
                                <td>${formatDateTime(activity.createdAt)} (${formatTimeAgo(activity.createdAt)})</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>User Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <th>User:</th>
                                <td>${escapeHtml(activity.userName)}</td>
                            </tr>
                            <tr>
                                <th>Role:</th>
                                <td><span class="badge ${getRoleBadgeClass(activity.userRole)}">${escapeHtml(activity.userRole)}</span></td>
                            </tr>
                            <tr>
                                <th>IP Address:</th>
                                <td><code>${activity.ipAddress || 'N/A'}</code></td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Details</h6>
                        <div class="card">
                            <div class="card-body">
                                <p class="mb-0">${escapeHtml(activity.details || 'No details provided')}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            content.html(detailsHtml);
            modal.modal('show');
        }

        // Update pagination
        function updatePagination(data) {
            totalPages = data.totalPages;
            updateCount(data.total);

            const pagination = $('#pagination');
            pagination.empty();

            // Previous button
            const prevDisabled = currentPage <= 1 ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" onclick="loadActivityLogs(${currentPage - 1}); return false;">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `);

            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const active = i === currentPage ? 'active' : '';
                pagination.append(`
                    <li class="page-item ${active}">
                        <a class="page-link" href="#" onclick="loadActivityLogs(${i}); return false;">${i}</a>
                    </li>
                `);
            }

            // Next button
            const nextDisabled = currentPage >= totalPages ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" onclick="loadActivityLogs(${currentPage + 1}); return false;">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `);

            // Pagination info
            const startItem = (currentPage - 1) * pageSize + 1;
            const endItem = Math.min(currentPage * pageSize, data.total);
            $('#paginationInfo').html(`
                Showing ${startItem} to ${endItem} of ${data.total} entries
            `);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Refresh button
            $('#refreshLogs').click(() => loadActivityLogs(currentPage));

            // Export button
            $('#exportLogs').click(async () => {
                try {
                    showLoading('Exporting...');
                    const response = await fetch('/ActivityLog/ExportLogs', {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        }
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `activity_logs_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        showToast('Export completed successfully', 'success');
                    } else {
                        const error = await response.json();
                        showToast(error.message || 'Export failed', 'error');
                    }
                } catch (error) {
                    console.error('Export error:', error);
                    showToast('Failed to export logs', 'error');
                } finally {
                    hideLoading();
                }
            });

            // Clear logs confirmation
            $('#confirmClearLogs').click(async () => {
                try {
                    showLoading('Clearing logs...');
                    const response = await fetch('/ActivityLog/ClearLogs', {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        showToast(data.message, 'success');
                        $('#clearLogsModal').modal('hide');
                    } else {
                        showToast(data.message, 'error');
                    }
                } catch (error) {
                    showToast('Failed to clear logs', 'error');
                } finally {
                    hideLoading();
                }
            });

            // Statistics buttons
            $('#showStatistics').click(() => {
                $('#statisticsDashboard').removeClass('d-none');
                loadStatistics();
            });

            $('#hideStatistics').click(() => {
                $('#statisticsDashboard').addClass('d-none');
            });

            // Filter changes
            $('#dateFrom, #dateTo, #userRoleFilter, #actionFilter').change(applyFilters);
            $('#searchInput').on('input', debounce(applyFilters, 500));
            $('#searchBtn').click(applyFilters);

            // Clear filters
            $('#clearFilters').click(() => {
                $('#dateFrom').val('');
                $('#dateTo').val('');
                $('#userRoleFilter').val('');
                $('#actionFilter').val('');
                $('#searchInput').val('');
                applyFilters();
            });

            // Auto-refresh toggle
            $('#autoRefresh').change(function() {
                if (this.checked) {
                    setupAutoRefresh();
                } else {
                    clearAutoRefresh();
                }
            });
        }

        // Apply filters
        function applyFilters() {
            filters = {
                dateFrom: $('#dateFrom').val(),
                dateTo: $('#dateTo').val(),
                userRole: $('#userRoleFilter').val(),
                action: $('#actionFilter').val(),
                search: $('#searchInput').val()
            };

            loadActivityLogs(1);
        }

        // Setup auto-refresh
        function setupAutoRefresh() {
            clearAutoRefresh();
            if ($('#autoRefresh').is(':checked')) {
                autoRefreshTimer = setInterval(() => {
                    loadActivityLogs(currentPage);
                }, 30000); // Refresh every 30 seconds
            }
        }

        // Clear auto-refresh
        function clearAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
        }

        // Load statistics
        async function loadStatistics() {
            try {
                $('#statisticsContent').html(`
                    <div class="col-12 text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading statistics...</p>
                    </div>
                `);

                const response = await fetch('/ActivityLog/GetStatistics');
                const data = await response.json();

                if (data.success) {
                    renderStatistics(data.data);
                } else {
                    $('#statisticsContent').html(`
                        <div class="col-12">
                            <div class="alert alert-danger">Error loading statistics: ${data.message}</div>
                        </div>
                    `);
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
                $('#statisticsContent').html(`
                    <div class="col-12">
                        <div class="alert alert-danger">Failed to load statistics</div>
                    </div>
                `);
            }
        }

        // Render statistics
        function renderStatistics(stats) {
            const statsHtml = `
                <!-- Quick Stats -->
                <div class="col-md-3 mb-3">
                    <div class="card stat-card border-left-primary">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <div class="text-muted small mb-1">Total Activities</div>
                                    <div class="h4 mb-0">${stats.TotalActivities.toLocaleString()}</div>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-history fa-2x text-primary"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-3">
                    <div class="card stat-card border-left-success">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <div class="text-muted small mb-1">Today</div>
                                    <div class="h4 mb-0">${stats.TodayActivities}</div>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-calendar-day fa-2x text-success"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-3">
                    <div class="card stat-card border-left-info">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <div class="text-muted small mb-1">This Week</div>
                                    <div class="h4 mb-0">${stats.ThisWeekActivities}</div>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-calendar-week fa-2x text-info"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 mb-3">
                    <div class="card stat-card border-left-warning">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <div class="text-muted small mb-1">Most Active</div>
                                    <div class="h6 mb-0">${escapeHtml(stats.MostActiveUser)}</div>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-user-check fa-2x text-warning"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Summary -->
                <div class="col-12 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Recent Activities</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                ${renderRecentActivities(stats.RecentActivityTypes)}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            $('#statisticsContent').html(statsHtml);
        }

        function renderRecentActivities(activities) {
            if (!activities || Object.keys(activities).length === 0) {
                return '<div class="list-group-item text-center text-muted py-4">No recent activities</div>';
            }

            let html = '';
            Object.entries(activities).forEach(([action, count]) => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge ${getActionColorClass(action)} me-2">${escapeHtml(action)}</span>
                            </div>
                            <div>
                                <span class="text-muted">${count} activities</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            return html;
        }

        // Helper functions
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);

            if (diffDay > 0) return `${diffDay} day${diffDay > 1 ? 's' : ''} ago`;
            if (diffHour > 0) return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
            if (diffMin > 0) return `${diffMin} minute${diffMin > 1 ? 's' : ''} ago`;
            return 'Just now';
        }

        function getRoleBadgeClass(role) {
            switch(role) {
                case 'Administrator': return 'badge-admin';
                case 'Staff': return 'badge-staff';
                case 'System': return 'badge-system';
                default: return 'badge-secondary';
            }
        }

        function getActionColorClass(action) {
            if (action.includes('Error') || action.includes('Failed')) return 'text-danger';
            if (action.includes('Success') || action.includes('Added') || action.includes('Created')) return 'text-success';
            if (action.includes('Warning') || action.includes('Updated') || action.includes('Modified')) return 'text-warning';
            if (action.includes('Delete') || action.includes('Remove') || action.includes('Clear')) return 'text-danger';
            if (action.includes('Login') || action.includes('Logout')) return 'text-info';
            return 'text-primary';
        }

        function updateCount(count) {
            $('#totalCount').text(`Total: ${count.toLocaleString()} records`);
        }

        function updateLastUpdated() {
            const now = new Date();
            $('#lastUpdated').text(`Last updated: ${now.toLocaleTimeString()}`);
        }

        function showLoading(message = 'Loading...') {
            // Show loading indicator
            $('#logsTableBody').html(`
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">${message}</p>
                    </td>
                </tr>
            `);
        }

        function hideLoading() {
            // Nothing to do here
        }

        function showToast(message, type = 'info') {
            const toastEl = document.getElementById('liveToast');
            const toastBody = document.getElementById('toastBody');

            if (toastEl && toastBody) {
                // Update toast content
                toastBody.textContent = message;

                // Update toast color based on type
                const toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        }

        function showError(message) {
            $('#logsTableBody').html(`
                <tr>
                    <td colspan="8" class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <p>${message}</p>
                        <button class="btn btn-sm btn-primary mt-2" onclick="loadActivityLogs(${currentPage})">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </td>
                </tr>
            `);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            clearAutoRefresh();
            if (connection) {
                connection.stop();
            }
        });
    </script>
}