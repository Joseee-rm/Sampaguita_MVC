@model List<SeniorManagement.Models.PensionLog>
@{
    ViewData["Title"] = "Pension Logs";

    // Get unique years and months for filter dropdowns
    var years = Model.Select(l => l.Year).Distinct().OrderByDescending(y => y).ToList();
    var months = new[]
    {
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
    };

    // Get filter parameters
    string fromMonth = ViewBag.FromMonth != null ? (string)ViewBag.FromMonth : "";
    int? fromYear = ViewBag.FromYear != null ? (int?)ViewBag.FromYear : null;
    string toMonth = ViewBag.ToMonth != null ? (string)ViewBag.ToMonth : "";
    int? toYear = ViewBag.ToYear != null ? (int?)ViewBag.ToYear : null;

    // Filter logs based on date range
    List<PensionLog> filteredLogs = Model;

    if (fromYear.HasValue && !string.IsNullOrEmpty(fromMonth) &&
        toYear.HasValue && !string.IsNullOrEmpty(toMonth))
    {
        // Convert month names to numbers for comparison
        int fromMonthNum = Array.IndexOf(months, fromMonth) + 1;
        int toMonthNum = Array.IndexOf(months, toMonth) + 1;

        filteredLogs = Model.Where(log =>
        {
            int logMonthNum = Array.IndexOf(months, log.Month) + 1;

            // Check if log is within the date range
            if (log.Year == fromYear.Value && log.Year == toYear.Value)
            {
                // Same year, check month range
                return logMonthNum >= fromMonthNum && logMonthNum <= toMonthNum;
            }
            else if (log.Year == fromYear.Value)
            {
                // From year, check if month is >= from month
                return logMonthNum >= fromMonthNum;
            }
            else if (log.Year == toYear.Value)
            {
                // To year, check if month is <= to month
                return logMonthNum <= toMonthNum;
            }
            else
            {
                // Check if year is between from and to years
                return log.Year > fromYear.Value && log.Year < toYear.Value;
            }
        }).ToList();
    }

    // Parse pension type and frequency from notes for statistics
    var pensionTypeStats = new Dictionary<string, (int Total, int Claimed, int Amount)>();
    int totalClaimedSeniors = 0;
    int totalSeniors = 0;
    int totalClaimedAmount = 0;

    foreach (var log in filteredLogs)
    {
        // Extract pension type from notes if available
        var notesParts = log.Notes.Split(',');
        string pensionType = "All Types";

        // Try to find pension type in notes
        foreach (var part in notesParts)
        {
            if (part.Contains("Pension Type:"))
            {
                var typePart = part.Split(':');
                if (typePart.Length >= 2)
                {
                    pensionType = typePart[1].Trim();
                    break;
                }
            }
        }

        // Extract total and claimed counts
        int logTotalSeniors = 0;
        int logClaimedSeniors = 0;
        int logClaimedAmount = 0;

        if (notesParts.Length >= 3)
        {
            // Extract total seniors
            if (notesParts[0].Contains("Total Seniors:"))
            {
                var totalPart = notesParts[0].Split(':');
                if (totalPart.Length >= 2 && int.TryParse(totalPart[1].Trim(), out int total))
                {
                    logTotalSeniors = total;
                    totalSeniors += total;
                }
            }

            // Extract claimed seniors
            if (notesParts[1].Contains("Claimed:"))
            {
                var claimedPart = notesParts[1].Split(':');
                if (claimedPart.Length >= 2 && int.TryParse(claimedPart[1].Trim(), out int claimed))
                {
                    logClaimedSeniors = claimed;
                    totalClaimedSeniors += claimed;
                }
            }

            // Extract claimed amount
            if (notesParts[2].Contains("Claimed Amount:"))
            {
                var amountPart = notesParts[2].Split(':');
                if (amountPart.Length >= 2)
                {
                    var amountStr = amountPart[1].Trim().Replace("₱", "").Replace(".00", "");
                    if (int.TryParse(amountStr, out int amount))
                    {
                        logClaimedAmount = amount;
                        totalClaimedAmount += amount;
                    }
                }
            }
        }

        if (!pensionTypeStats.ContainsKey(pensionType))
        {
            pensionTypeStats[pensionType] = (0, 0, 0);
        }
        var stats = pensionTypeStats[pensionType];
        pensionTypeStats[pensionType] = (stats.Total + logTotalSeniors, stats.Claimed + logClaimedSeniors, stats.Amount + logClaimedAmount);
    }
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-history text-info mr-2"></i>Pension Logs
        </h1>
        <!-- In the header section, add the Frequency Dashboard button -->
        <div class="btn-group">
            <a href="@Url.Action("Pension", "Dues")" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left mr-2"></i>Back to Pension
            </a>
            <a href="@Url.Action("PensionFrequencyDashboard", "Dues")" class="btn btn-outline-info ml-2">
                <i class="fas fa-chart-pie mr-2"></i>Frequency Dashboard
            </a>
        </div>
    </div>

    <!-- Error Alert -->
    @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @ViewBag.ErrorMessage
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    <!-- Date Range Filter Card -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Filter by Date Range</h6>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <!-- From Date -->
                <div class="col-md-3">
                    <label class="form-label">From Month</label>
                    <select name="fromMonth" class="form-control">
                        <option value="">Select Month</option>
                        @foreach (var month in months)
                        {
                            bool isSelected = month == fromMonth;
                            <option value="@month" selected="@isSelected">@month</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">From Year</label>
                    <select name="fromYear" class="form-control">
                        <option value="">Select Year</option>
                        @foreach (var year in years)
                        {
                            bool isSelected = year == fromYear;
                            <option value="@year" selected="@isSelected">@year</option>
                        }
                    </select>
                </div>

                <!-- To Date -->
                <div class="col-md-3">
                    <label class="form-label">To Month</label>
                    <select name="toMonth" class="form-control">
                        <option value="">Select Month</option>
                        @foreach (var month in months)
                        {
                            bool isSelected = month == toMonth;
                            <option value="@month" selected="@isSelected">@month</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">To Year</label>
                    <select name="toYear" class="form-control">
                        <option value="">Select Year</option>
                        @foreach (var year in years)
                        {
                            bool isSelected = year == toYear;
                            <option value="@year" selected="@isSelected">@year</option>
                        }
                    </select>
                </div>

                <!-- Buttons -->
                <div class="col-md-2">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter mr-1"></i>Apply Filter
                        </button>
                        <a href="@Url.Action("ViewPensionLogs", "Dues")" class="btn btn-outline-secondary">
                            <i class="fas fa-times mr-1"></i>Clear All
                        </a>
                    </div>
                </div>
            </form>

            <!-- Filter Status -->
            @if (!string.IsNullOrEmpty(fromMonth) && fromYear.HasValue &&
                        !string.IsNullOrEmpty(toMonth) && toYear.HasValue)
            {
                <div class="alert alert-info mt-3 mb-0" role="alert">
                    <div class="row">
                        <div class="col-md-8">
                            <i class="fas fa-info-circle mr-2"></i>
                            Showing pension logs from <strong>@fromMonth @fromYear</strong> to <strong>@toMonth @toYear</strong>
                            <br>
                            <small class="mt-1">
                                <i class="fas fa-users mr-1"></i>Total Pensioners: @totalSeniors |
                                <i class="fas fa-check-circle mr-1"></i>Claimed: @totalClaimedSeniors |
                                <i class="fas fa-money-bill-wave mr-1"></i>Claimed Amount: ₱@totalClaimedAmount
                            </small>

                            @if (pensionTypeStats.Any())
                            {
                                <div class="mt-2">
                                    <small class="font-weight-bold">Pension Type Breakdown:</small>
                                    @foreach (var stat in pensionTypeStats.OrderByDescending(s => s.Value.Total))
                                    {
                                        var claimRate = stat.Value.Total > 0 ? (stat.Value.Claimed * 100 / stat.Value.Total) : 0;
                                        <span class="badge badge-secondary mr-1 mb-1" title="@stat.Key: @stat.Value.Claimed/@stat.Value.Total claimed (@claimRate%)">
                                            @stat.Key: @stat.Value.Total
                                        </span>
                                    }
                                </div>
                            }
                        </div>
                        <div class="col-md-4 text-right">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="exportFilteredPensionCsv()">
                                <i class="fas fa-file-excel mr-1"></i>Export Filtered CSV
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Pension Logs Table -->
    <div class="card shadow">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">
                Saved Pension Logs
                @if (!string.IsNullOrEmpty(fromMonth) && fromYear.HasValue &&
                                !string.IsNullOrEmpty(toMonth) && toYear.HasValue)
                {
                    <span class="badge badge-info ml-2">
                        @fromMonth @fromYear - @toMonth @toYear
                    </span>
                }
            </h6>
            <div class="text-muted">
                <small>
                    <i class="fas fa-chart-bar mr-1"></i>
                    Showing @filteredLogs.Count out of @Model.Count log(s)
                </small>
            </div>
        </div>
        <div class="card-body">
            @if (filteredLogs.Any())
            {
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="pensionLogsTable" width="100%" cellspacing="0">
                        <thead class="bg-light">
                            <tr>
                                <th>Month</th>
                                <th>Year</th>
                                <th>Saved Date</th>
                                <th>Pension Type</th>
                                <th>Notes Summary</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var log in filteredLogs.OrderByDescending(l => l.Year).ThenByDescending(l => Array.IndexOf(months, l.Month)))
                            {
                                // Extract pension type from notes
                                string pensionType = "All Types";
                                string notesSummary = log.Notes;
                                var notesParts = log.Notes.Split(',');

                                if (notesParts.Length >= 4 && notesParts[3].Contains("Pension Type:"))
                                {
                                    var typePart = notesParts[3].Split(':');
                                    if (typePart.Length >= 2)
                                    {
                                        pensionType = typePart[1].Trim();
                                        // Create a cleaner summary without the pension type part
                                        notesSummary = string.Join(",", notesParts.Take(3));
                                    }
                                }
                                else if (notesParts.Length >= 1)
                                {
                                    // Try to find pension type elsewhere in notes
                                    foreach (var part in notesParts)
                                    {
                                        if (part.Contains("Pension Type:"))
                                        {
                                            var typePart = part.Split(':');
                                            if (typePart.Length >= 2)
                                            {
                                                pensionType = typePart[1].Trim();
                                                break;
                                            }
                                        }
                                    }
                                }

                                <tr>
                                    <td>
                                        <strong>@log.Month</strong>
                                    </td>
                                    <td>
                                        <span class="badge badge-secondary">@log.Year</span>
                                    </td>
                                    <td>@log.CreatedAt.ToString("MMM dd, yyyy HH:mm")</td>
                                    <td>
                                        @if (pensionType != "All Types")
                                        {
                                            <span class="badge badge-info">@pensionType</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">All Types</span>
                                        }
                                    </td>
                                    <td>
                                        <small class="text-muted">@notesSummary</small>
                                        <br>
                                        <small class="text-muted">
                                            <i class="fas fa-file-alt mr-1"></i>
                                            @if (!string.IsNullOrEmpty(log.FilePath))
                                            {
                                                <span class="text-success">File saved</span>
                                            }
                                            else
                                            {
                                                <span class="text-danger">No file</span>
                                            }
                                        </small>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(log.FilePath))
                                        {
                                            <div class="btn-group btn-group-sm">
                                                <a href="@Url.Action("DownloadPensionLog", "Dues", new { month = log.Month, year = log.Year })"
                                                   class="btn btn-outline-primary"
                                                   title="Download CSV File">
                                                    <i class="fas fa-download mr-1"></i>Download
                                                </a>
                                                <button class="btn btn-outline-info ml-1"
                                                        onclick="viewLogDetails('@log.Month', @log.Year)"
                                                        title="View Log Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted">No file</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center text-muted py-4">
                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                    <p class="mb-0">
                        @if (!string.IsNullOrEmpty(fromMonth) || fromYear.HasValue ||
                                            !string.IsNullOrEmpty(toMonth) || toYear.HasValue)
                        {
                            <text>No pension logs found for the selected date range.</text>
                        }
                        else
                        {
                            <text>No pension logs found. Save a log from the Pension page.</text>
                        }
                    </p>
                    @if (!string.IsNullOrEmpty(fromMonth) || fromYear.HasValue ||
                                    !string.IsNullOrEmpty(toMonth) || toYear.HasValue)
                    {
                        <a href="@Url.Action("ViewPensionLogs", "Dues")" class="btn btn-outline-primary mt-3">
                            <i class="fas fa-eye mr-1"></i>View All Pension Logs
                        </a>
                    }
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize DataTable if table exists
            if ($('#pensionLogsTable').length) {
                $('#pensionLogsTable').DataTable({
                    "order": [[2, "desc"]],
                    "pageLength": 10,
                    "language": {
                        "emptyTable": "No pension logs available",
                        "search": "Search pension logs:"
                    }
                });
            }
        });

        // Export Filtered Pension CSV
        function exportFilteredPensionCsv() {
            var fromMonth = '@fromMonth';
            var fromYear = '@fromYear';
            var toMonth = '@toMonth';
            var toYear = '@toYear';

            if (!fromMonth || !fromYear || !toMonth || !toYear) {
                alert('Please apply a date range filter first.');
                return;
            }

            var url = '@Url.Action("ExportFilteredPensionCsv", "Dues")' +
                '?fromMonth=' + encodeURIComponent(fromMonth) +
                '&fromYear=' + fromYear +
                '&toMonth=' + encodeURIComponent(toMonth) +
                '&toYear=' + toYear;

            window.location.href = url;
        }

        // View Log Details
        function viewLogDetails(month, year) {
            // In a real implementation, this would open a modal with detailed log information
            alert('Log details for ' + month + ' ' + year + ':\n\n' +
                  'Detailed information would be displayed here including:\n' +
                  '- Complete notes\n' +
                  '- File information\n' +
                  '- Pension type breakdown\n' +
                  '- Claim statistics');
        }
    </script>
}