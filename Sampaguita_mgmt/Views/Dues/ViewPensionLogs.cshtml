@model List<SeniorManagement.Models.PensionLog>
@{
    ViewData["Title"] = "Pension Logs";

    // Get unique years and months for filter dropdowns
    var years = Model.Select(l => l.Year).Distinct().OrderByDescending(y => y).ToList();
    var months = new[]
    {
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
    };

    // Get filter parameters
    var fromMonth = ViewBag.FromMonth != null ? (string)ViewBag.FromMonth : "";
    var fromYear = ViewBag.FromYear != null ? (int?)ViewBag.FromYear : null;
    var toMonth = ViewBag.ToMonth != null ? (string)ViewBag.ToMonth : "";
    var toYear = ViewBag.ToYear != null ? (int?)ViewBag.ToYear : null;

    // Filter logs based on date range
    List<PensionLog> filteredLogs = Model;

    if (fromYear.HasValue && !string.IsNullOrEmpty(fromMonth) &&
        toYear.HasValue && !string.IsNullOrEmpty(toMonth))
    {
        // Convert month names to numbers for comparison
        int fromMonthNum = Array.IndexOf(months, fromMonth) + 1;
        int toMonthNum = Array.IndexOf(months, toMonth) + 1;

        filteredLogs = Model.Where(log =>
        {
            int logMonthNum = Array.IndexOf(months, log.Month) + 1;

            // Check if log is within the date range
            if (log.Year == fromYear.Value && log.Year == toYear.Value)
            {
                // Same year, check month range
                return logMonthNum >= fromMonthNum && logMonthNum <= toMonthNum;
            }
            else if (log.Year == fromYear.Value)
            {
                // From year, check if month is >= from month
                return logMonthNum >= fromMonthNum;
            }
            else if (log.Year == toYear.Value)
            {
                // To year, check if month is <= to month
                return logMonthNum <= toMonthNum;
            }
            else
            {
                // Check if year is between from and to years
                return log.Year > fromYear.Value && log.Year < toYear.Value;
            }
        }).ToList();
    }
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-history text-info mr-2"></i>Pension Logs
        </h1>
        <a href="@Url.Action("Pension", "Dues")" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left mr-2"></i>Back to Pension
        </a>
    </div>

    <!-- Error Alert -->
    @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @ViewBag.ErrorMessage
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    <!-- Date Range Filter Card -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Filter by Date Range</h6>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <!-- From Date -->
                <div class="col-md-3">
                    <label class="form-label">From Month</label>
                    <select name="fromMonth" class="form-control">
                        <option value="">Select Month</option>
                        @foreach (var month in months)
                        {
                            var isSelected = month == fromMonth;
                            <option value="@month" selected="@isSelected">@month</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">From Year</label>
                    <select name="fromYear" class="form-control">
                        <option value="">Select Year</option>
                        @foreach (var year in years)
                        {
                            var isSelected = year == fromYear;
                            <option value="@year" selected="@isSelected">@year</option>
                        }
                    </select>
                </div>

                <!-- To Date -->
                <div class="col-md-3">
                    <label class="form-label">To Month</label>
                    <select name="toMonth" class="form-control">
                        <option value="">Select Month</option>
                        @foreach (var month in months)
                        {
                            var isSelected = month == toMonth;
                            <option value="@month" selected="@isSelected">@month</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">To Year</label>
                    <select name="toYear" class="form-control">
                        <option value="">Select Year</option>
                        @foreach (var year in years)
                        {
                            var isSelected = year == toYear;
                            <option value="@year" selected="@isSelected">@year</option>
                        }
                    </select>
                </div>

                <!-- Buttons -->
                <div class="col-md-2">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter mr-1"></i>Apply Filter
                        </button>
                        <a href="@Url.Action("ViewPensionLogs", "Dues")" class="btn btn-outline-secondary">
                            <i class="fas fa-times mr-1"></i>Clear All
                        </a>
                    </div>
                </div>
            </form>

            <!-- Filter Status -->
            @if (!string.IsNullOrEmpty(fromMonth) && fromYear.HasValue &&
                        !string.IsNullOrEmpty(toMonth) && toYear.HasValue)
            {
                // Calculate totals for display
                int totalClaimedSeniors = 0;
                int totalSeniors = 0;

                foreach (var log in filteredLogs)
                {
                    var notesParts = log.Notes.Split(',');
                    if (notesParts.Length >= 2)
                    {
                        if (notesParts[0].Contains("Total Seniors:"))
                        {
                            var totalPart = notesParts[0].Split(':');
                            if (totalPart.Length >= 2 && int.TryParse(totalPart[1].Trim(), out int total))
                            {
                                totalSeniors += total;
                            }
                        }

                        if (notesParts[1].Contains("Claimed:"))
                        {
                            var claimedPart = notesParts[1].Split(':');
                            if (claimedPart.Length >= 2 && int.TryParse(claimedPart[1].Trim(), out int claimed))
                            {
                                totalClaimedSeniors += claimed;
                            }
                        }
                    }
                }

                int totalClaimedAmount = totalClaimedSeniors * 500;

                <div class="alert alert-info mt-3 mb-0" role="alert">
                    <div class="row">
                        <div class="col-md-8">
                            <i class="fas fa-info-circle mr-2"></i>
                            Showing pension logs from <strong>@fromMonth @fromYear</strong> to <strong>@toMonth @toYear</strong>
                            <br>
                            <small class="mt-1">
                                <i class="fas fa-users mr-1"></i>Total Pensioners: @totalSeniors |
                                <i class="fas fa-check-circle mr-1"></i>Claimed: @totalClaimedSeniors |
                                <i class="fas fa-money-bill-wave mr-1"></i>Claimed Amount: ₱@totalClaimedAmount
                            </small>
                        </div>
                        <div class="col-md-4 text-right">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="exportFilteredPensionCsv()">
                                <i class="fas fa-file-excel mr-1"></i>Export Filtered CSV
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Pension Logs Table -->
    <div class="card shadow">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">
                Saved Pension Logs
                @if (!string.IsNullOrEmpty(fromMonth) && fromYear.HasValue &&
                                !string.IsNullOrEmpty(toMonth) && toYear.HasValue)
                {
                    <span class="badge badge-info ml-2">
                        @fromMonth @fromYear - @toMonth @toYear
                    </span>
                }
            </h6>
            <div class="text-muted">
                <small>
                    <i class="fas fa-chart-bar mr-1"></i>
                    Showing @filteredLogs.Count out of @Model.Count log(s)
                </small>
            </div>
        </div>
        <div class="card-body">
            @if (filteredLogs.Any())
            {
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="pensionLogsTable" width="100%" cellspacing="0">
                        <thead class="bg-light">
                            <tr>
                                <th>Month</th>
                                <th>Year</th>
                                <th>Saved Date</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var log in filteredLogs.OrderBy(l => l.Year).ThenBy(l =>
                                                    Array.IndexOf(months, l.Month)))
                            {
                                <tr>
                                    <td>
                                        <strong>@log.Month</strong>
                                    </td>
                                    <td>
                                        <span class="badge badge-secondary" style="background-color: #6c757d !important; color: white !important;">@log.Year</span>
                                    </td>
                                    <td>@log.CreatedAt.ToString("MMM dd, yyyy HH:mm")</td>
                                    <td>
                                        <small class="text-muted">@log.Notes</small>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(log.FilePath))
                                        {
                                            <a href="@Url.Action("DownloadPensionLog", "Dues", new { month = log.Month, year = log.Year })"
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-download mr-1"></i>Download CSV
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="text-muted">No file</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center text-muted py-4">
                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                    <p class="mb-0">
                        @if (!string.IsNullOrEmpty(fromMonth) || fromYear.HasValue ||
                                            !string.IsNullOrEmpty(toMonth) || toYear.HasValue)
                        {
                            <text>No pension logs found for the selected date range.</text>
                        }
                        else
                        {
                            <text>No pension logs found. Save a log from the Pension page.</text>
                        }
                    </p>
                    @if (!string.IsNullOrEmpty(fromMonth) || fromYear.HasValue ||
                                    !string.IsNullOrEmpty(toMonth) || toYear.HasValue)
                    {
                        <a href="@Url.Action("ViewPensionLogs", "Dues")" class="btn btn-outline-primary mt-3">
                            <i class="fas fa-eye mr-1"></i>View All Pension Logs
                        </a>
                    }
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('#pensionLogsTable').DataTable({
                "order": [[2, "desc"]], // Sort by Saved Date descending
                "pageLength": 10,
                "language": {
                    "emptyTable": "No pension logs available",
                    "search": "Search pension logs:"
                }
            });
        });

        // Export Filtered Pension CSV
        function exportFilteredPensionCsv() {
            var fromMonth = '@fromMonth';
            var fromYear = '@fromYear';
            var toMonth = '@toMonth';
            var toYear = '@toYear';

            if (!fromMonth || !fromYear || !toMonth || !toYear) {
                alert('Please apply a date range filter first.');
                return;
            }

            var url = '@Url.Action("ExportFilteredPensionCsv", "Dues")' +
                '?fromMonth=' + encodeURIComponent(fromMonth) +
                '&fromYear=' + fromYear +
                '&toMonth=' + encodeURIComponent(toMonth) +
                '&toYear=' + toYear;

            window.location.href = url;
        }
    </script>
}