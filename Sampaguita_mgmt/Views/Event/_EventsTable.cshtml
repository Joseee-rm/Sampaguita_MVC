@model List<SeniorManagement.Models.Event>

@if (Model.Any())
{
    <div class="table-responsive event-table-desktop">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Event Title</th>
                    <th>Type</th>
                    <th>Date & Time</th>
                    <th>Location</th>
                    <th>Attendance</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var eventItem in Model)
                {
                    var isFull = eventItem.MaxCapacity.HasValue && eventItem.AttendanceCount >= eventItem.MaxCapacity.Value;
                    <tr data-event-id="@eventItem.Id">
                        <td>
                            <div class="fw-bold text-primary">@eventItem.EventTitle</div>
                            <small class="text-muted">@(eventItem.EventDescription?.Length > 50 ? eventItem.EventDescription.Substring(0, 50) + "..." : eventItem.EventDescription)</small>
                            <div><small class="text-muted">By: @eventItem.OrganizedBy</small></div>
                        </td>
                        <td>
                            <span class="badge bg-primary">@eventItem.EventTypeDisplay</span>
                        </td>
                        <td>
                            <div class="fw-bold">@eventItem.EventDate.ToString("MMM dd, yyyy")</div>
                            <small class="text-muted">@eventItem.DisplayTime</small>
                        </td>
                        <td>@eventItem.EventLocation</td>
                        <td>
                            <div class="attendance-counter">
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-sm attendance-btn minus"
                                            onclick="updateAttendance(@eventItem.Id, -1)"
                                            @if (eventItem.AttendanceCount <= 0)
                                            {
                                                <text>disabled</text>
                                            }
        >
                                                <i class="fas fa-minus"></i>
                                            </button>
                                    <div class="text-center mx-2">
                                        <div class="fw-bold fs-5 attendance-count" data-max-capacity="@eventItem.MaxCapacity">
                                            @eventItem.AttendanceCount
                                        </div>
                                        @if (eventItem.MaxCapacity.HasValue)
                                        {
                                            <small class="text-muted">/@eventItem.MaxCapacity</small>
                                            <div class="capacity-progress" style="width: 60px;">
                                                <div class="progress-bar" role="progressbar"
                                                     style="width: @(eventItem.AttendancePercentage)%"></div>
                                            </div>
                                        }
                                    </div>
                                    <button class="btn btn-sm attendance-btn plus"
                                            onclick="updateAttendance(@eventItem.Id, 1)"
                                            @if (isFull)
                                            {
                                                <text>disabled</text>
                                            }
        >
                                                <i class="fas fa-plus"></i>
                                            </button>
                                </div>
                                @if (eventItem.MaxCapacity.HasValue)
                                {
                                    <small class="text-muted d-block mt-1">
                                        @eventItem.AttendancePercentage% full
                                        @if (isFull)
                                        {
                                            <span class="badge bg-danger ms-1">Full</span>
                                        }
                                    </small>
                                }
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <select class="form-select form-select-sm status-dropdown"
                                        data-event-id="@eventItem.Id"
                                        data-original-status="@eventItem.Status"
                                        style="width: 120px;">
                                    <option value="Scheduled" selected="@(eventItem.Status == "Scheduled")">Scheduled</option>
                                    <option value="Ongoing" selected="@(eventItem.Status == "Ongoing")">Ongoing</option>
                                    <option value="Completed" selected="@(eventItem.Status == "Completed")">Completed</option>
                                    <option value="Cancelled" selected="@(eventItem.Status == "Cancelled")">Cancelled</option>
                                </select>
                                <span class="badge @GetStatusBadgeClass(eventItem.Status) ms-2">
                                    @eventItem.Status
                                </span>
                            </div>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" data-event-id="@eventItem.Id">
                                <a href="@Url.Action("Edit", "Event", new { id = eventItem.Id })"
                                   class="btn btn-outline-primary" title="Edit Event">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-outline-warning archive-btn"
                                        onclick="archiveEvent(@eventItem.Id, '@eventItem.EventTitle.Replace("'", "\\'")')"
                                        title="Archive Event">
                                    <i class="fas fa-archive"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Mobile Cards Container -->
    <div class="event-card-mobile"></div>
}
else
{
    <div class="text-center py-5">
        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">No Events Found</h4>
        <p class="text-muted">There are no events in this category.</p>
        <a href="@Url.Action("Create", "Event")" class="btn btn-primary gradient-btn">
            <i class="fas fa-plus me-1"></i> Create New Event
        </a>
    </div>
}

@functions {
    public string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Scheduled" => "bg-primary",
            "Ongoing" => "bg-warning",
            "Completed" => "bg-success",
            "Cancelled" => "bg-danger",
            "Archived" => "bg-secondary",
            _ => "bg-secondary"
        };
    }
}

<style>
    /* Additional inline styles for the partial view */
    .attendance-counter {
        min-width: 140px;
    }

    .attendance-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    .capacity-progress {
        height: 6px;
        border-radius: 3px;
        background-color: #e9ecef;
        margin-top: 0.25rem;
        overflow: hidden;
    }

        .capacity-progress .progress-bar {
            background: linear-gradient(90deg, #17a2b8, #2dd4bf);
            transition: width 0.5s ease;
        }
</style>