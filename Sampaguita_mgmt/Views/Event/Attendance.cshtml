@model List<SeniorManagement.Models.Senior>
@{
    ViewData["Title"] = "Event Attendance";
    var eventDetails = ViewBag.EventDetails as SeniorManagement.Models.Event;
    var attendanceStatus = ViewBag.AttendanceStatus as Dictionary<string, string>;
    var presentCount = ViewBag.PresentCount as int? ?? 0;
    var absentCount = ViewBag.AbsentCount as int? ?? 0;
    var unmarkedCount = ViewBag.UnmarkedCount as int? ?? 0;
    var zones = ViewBag.AvailableZones as List<SeniorManagement.Models.Zone> ?? new List<SeniorManagement.Models.Zone>();

    // Helper functions
    string GetAttendanceBadgeClass(string status)
    {
        switch (status)
        {
            case "Present":
                return "badge bg-success";
            case "Absent":
                return "badge bg-danger";
            default:
                return "badge bg-secondary";
        }
    }

    string GetStatusBadgeClass(string status)
    {
        switch (status)
        {
            case "Upcoming":
                return "badge bg-primary";
            case "Scheduled":
                return "badge bg-info";
            case "Ongoing":
                return "badge bg-warning text-dark";
            case "Completed":
                return "badge bg-success";
            case "Confirmed":
                return "badge bg-success";
            case "Cancelled":
                return "badge bg-danger";
            default:
                return "badge bg-secondary";
        }
    }
}

<div class="container-fluid px-0">
    <!-- Header Section -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-primary text-white border-0">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="mb-1"><i class="fas fa-users me-2"></i>Event Attendance</h3>
                    <h4 class="mb-0 fw-light">@eventDetails.EventTitle</h4>
                    <small class="opacity-90">
                        <i class="fas fa-calendar me-1"></i>@eventDetails.EventDate.ToString("MMMM dd, yyyy")
                        <i class="fas fa-clock ms-3 me-1"></i>@eventDetails.TimeFormatted
                    </small>
                </div>
                <div class="text-end">
                    <div class="d-flex gap-2">
                        <a href="@Url.Action("View", "Event", new { id = eventDetails.Id })"
                           class="btn btn-outline-light">
                            <i class="fas fa-arrow-left me-1"></i>Back
                        </a>
                        <a href="@Url.Action("Edit", "Event", new { id = eventDetails.Id })"
                           class="btn btn-light text-primary">
                            <i class="fas fa-edit me-1"></i>Edit
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="card-body py-4">
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="card border-0 bg-success bg-opacity-10">
                        <div class="card-body text-center py-3">
                            <div class="display-4 text-success fw-bold">@presentCount</div>
                            <h6 class="text-muted mb-0">Present</h6>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 bg-danger bg-opacity-10">
                        <div class="card-body text-center py-3">
                            <div class="display-4 text-danger fw-bold">@absentCount</div>
                            <h6 class="text-muted mb-0">Absent</h6>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 bg-secondary bg-opacity-10">
                        <div class="card-body text-center py-3">
                            <div class="display-4 text-secondary fw-bold">@unmarkedCount</div>
                            <h6 class="text-muted mb-0">Unmarked</h6>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 bg-info bg-opacity-10">
                        <div class="card-body text-center py-3">
                            <div class="display-4 text-info fw-bold">@Model.Count</div>
                            <h6 class="text-muted mb-0">Total Seniors</h6>
                        </div>
                    </div>
                </div>
            </div>

            @if (eventDetails.MaxCapacity.HasValue)
            {
                var percentage = (int)Math.Round((double)presentCount / eventDetails.MaxCapacity.Value * 100);
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <span class="fw-medium">Capacity: @presentCount / @eventDetails.MaxCapacity.Value</span>
                                <span class="text-muted ms-2">(@percentage%)</span>
                            </div>
                            @if (presentCount >= eventDetails.MaxCapacity.Value)
                            {
                                <span class="badge bg-danger">Full</span>
                            }
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar
                                     @(percentage >= 90 ? "bg-danger" :
                                                                    percentage >= 70 ? "bg-warning" : "bg-success")"
                             style="width: @percentage%" role="progressbar">
                        </div>
                    </div>
                </div>
            </div>
                        }
        </div>
    </div>

    <div class="row g-4">
        <!-- Sidebar -->
        <div class="col-lg-3">
            <!-- Event Details Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2 text-info"></i>Event Details</h5>
                </div>
                <div class="card-body">
                    <dl class="mb-0">
                        <dt class="text-muted small">Location</dt>
                        <dd class="mb-3">@eventDetails.EventLocation</dd>

                        <dt class="text-muted small">Organizer</dt>
                        <dd class="mb-3">@eventDetails.OrganizedBy</dd>

                        <dt class="text-muted small">Type</dt>
                        <dd class="mb-3">
                            <span class="badge bg-primary">@eventDetails.EventType</span>
                        </dd>

                        <dt class="text-muted small">Status</dt>
                        <dd class="mb-0">
                            <span class="badge @GetStatusBadgeClass(eventDetails.Status)">
                                @eventDetails.Status
                            </span>
                        </dd>
                    </dl>
                </div>
            </div>

            <!-- Attendance Summary -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2 text-success"></i>Attendance Summary</h5>
                </div>
                <div class="card-body">
                    @if (Model.Count > 0)
                    {
                        var presentPercent = (int)Math.Round((double)presentCount / Model.Count * 100);
                        var absentPercent = (int)Math.Round((double)absentCount / Model.Count * 100);
                        var unmarkedPercent = (int)Math.Round((double)unmarkedCount / Model.Count * 100);

                        <div class="d-flex justify-content-center mb-4">
                            <div class="position-relative" style="width: 140px; height: 140px;">
                                <canvas id="attendanceChart" width="140" height="140"></canvas>
                            </div>
                        </div>

                        <div class="legend">
                            <div class="d-flex align-items-center mb-2">
                                <div class="color-indicator bg-success me-2"></div>
                                <div class="flex-grow-1">
                                    <span>Present</span>
                                </div>
                                <span class="fw-medium">@presentPercent% (@presentCount)</span>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <div class="color-indicator bg-danger me-2"></div>
                                <div class="flex-grow-1">
                                    <span>Absent</span>
                                </div>
                                <span class="fw-medium">@absentPercent% (@absentCount)</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="color-indicator bg-secondary me-2"></div>
                                <div class="flex-grow-1">
                                    <span>Unmarked</span>
                                </div>
                                <span class="fw-medium">@unmarkedPercent% (@unmarkedCount)</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <p class="text-muted mb-0">No seniors available</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2 text-warning"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success" onclick="markAllUnmarkedAsPresent()">
                            <i class="fas fa-check-circle me-2"></i>Mark All Unmarked as Present
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="clearAllAttendance()">
                            <i class="fas fa-trash-alt me-2"></i>Clear All Attendance
                        </button>
                    </div>

                    <div class="alert alert-warning mt-4 mb-0">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Important Rules</h6>
                        <ul class="small mb-0">
                            <li>Once marked <strong>Present</strong>, cannot be changed</li>
                            <li>Once marked <strong>Absent</strong>, cannot be changed to Present</li>
                            <li>Use bulk actions for efficiency</li>
                            <li>Changes are logged automatically</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9">
            <!-- Filters Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Senior Attendance List</h5>
                        <div class="d-flex gap-2">
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-user-friends me-1"></i>@Model.Count Total
                            </span>
                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#filtersCollapse">
                                <i class="fas fa-filter me-1"></i>Filters
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="collapse" id="filtersCollapse">
                    <div class="card-body border-bottom">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label small fw-medium">Search Seniors</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" id="searchSeniors" class="form-control"
                                           placeholder="Name, ID, or contact...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-medium">Zone</label>
                                <select id="filterZone" class="form-select">
                                    <option value="">All Zones</option>
                                    @foreach (var zone in zones.Where(z => z.IsActive).OrderBy(z => z.ZoneNumber))
                                    {
                                        <option value="@zone.ZoneNumber">Zone @zone.ZoneNumber - @zone.ZoneName</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-medium">Barangay</label>
                                <select id="filterBarangay" class="form-select">
                                    <option value="">All Barangays</option>
                                    @{
                                        var barangays = Model.Select(s => s.Barangay).Distinct().OrderBy(b => b);
                                        foreach (var barangay in barangays)
                                        {
                                            <option value="@barangay">@barangay</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small fw-medium">Status</label>
                                <select id="filterAttendance" class="form-select">
                                    <option value="">All Status</option>
                                    <option value="Present">Present Only</option>
                                    <option value="Absent">Absent Only</option>
                                    <option value="Unmarked">Unmarked Only</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="toggleSelectAll">
                                    <label class="form-check-label small" for="toggleSelectAll">Select All Visible Seniors</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="card-body p-0">
                    @if (Model.Any())
                    {
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-hover mb-0" id="attendanceTable">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th width="50">
                                            <input type="checkbox" id="selectAll" class="form-check-input">
                                        </th>
                                        <th>Senior ID</th>
                                        <th>Full Name</th>
                                        <th>Zone</th>
                                        <th>Barangay</th>
                                        <th>Age</th>
                                        <th>Gender</th>
                                        <th>Status</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var senior in Model)
                                    {
                                        var status = attendanceStatus != null && attendanceStatus.ContainsKey(senior.SeniorId)
                                        ? attendanceStatus[senior.SeniorId]
                                        : "Unmarked";

                                        <tr data-senior-id="@senior.SeniorId"
                                            data-zone="@senior.Zone"
                                            data-barangay="@senior.Barangay"
                                            data-status="@status"
                                            class="@(status == "Present" ? "table-success-light" : status == "Absent" ? "table-danger-light" : "")">
                                            <td>
                                                <input type="checkbox" class="form-check-input senior-checkbox"
                                                       value="@senior.SeniorId"
                                                       @(status == "Present" || status == "Absent" ? "disabled" : "") />
                                            </td>
                                            <td>
                                                <span class="fw-medium text-muted">@senior.SeniorId</span>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-circle-sm bg-primary text-white me-2">
                                                        @(senior.FirstName?.FirstOrDefault().ToString().ToUpper() ?? "S")
                                                    </div>
                                                    <div>
                                                        <div class="fw-medium">@senior.LastName, @senior.FirstName</div>
                                                        @if (!string.IsNullOrEmpty(senior.MiddleInitial))
                                                        {
                                                            <small class="text-muted">@senior.MiddleInitial.</small>
                                                        }
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-light text-dark border">Zone @senior.Zone</span>
                                            </td>
                                            <td>
                                                <span class="text-muted">@senior.Barangay</span>
                                            </td>
                                            <td>
                                                <span class="fw-medium">@senior.Age</span>
                                            </td>
                                            <td>
                                                <span class="badge @(senior.Gender == "Male" ? "bg-primary" : "bg-pink-light")">
                                                    @senior.Gender
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge @GetAttendanceBadgeClass(status)">
                                                    @status
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                <div class="btn-group btn-group-sm" role="group">
                                                    @if (status == "Unmarked")
                                                    {
                                                        <button class="btn btn-outline-success mark-present"
                                                                onclick="markAttendance('@senior.SeniorId', 'Present')"
                                                                title="Mark as Present">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger mark-absent"
                                                                onclick="markAttendance('@senior.SeniorId', 'Absent')"
                                                                title="Mark as Absent">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    }
                                                    else if (status == "Present")
                                                    {
                                                        <button class="btn btn-success" disabled title="Already Present">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn btn-outline-secondary" disabled title="Cannot change from Present">
                                                            <i class="fas fa-lock"></i>
                                                        </button>
                                                    }
                                                    else if (status == "Absent")
                                                    {
                                                        <button class="btn btn-outline-secondary" disabled title="Cannot change from Absent to Present">
                                                            <i class="fas fa-lock"></i>
                                                        </button>
                                                        <button class="btn btn-danger" disabled title="Already Absent">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <!-- Bulk Actions Footer -->
                        <div class="card-footer bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span id="selectedCount" class="badge bg-primary">0 selected</span>
                                    <small class="text-muted ms-3">
                                        Showing @Model.Count seniors
                                    </small>
                                </div>
                                <div class="d-flex gap-2">
                                    <div class="input-group" style="width: 280px;">
                                        <select id="bulkAction" class="form-select">
                                            <option value="Present">Mark as Present</option>
                                            <option value="Absent">Mark as Absent</option>
                                        </select>
                                        <button class="btn btn-primary" onclick="bulkMarkAttendance()" id="bulkActionBtn" disabled>
                                            <i class="fas fa-play me-1"></i> Apply
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-user-slash fa-4x text-muted mb-3"></i>
                            <h4 class="text-muted mb-2">No Active Seniors</h4>
                            <p class="text-muted mb-4">There are no active seniors in the system.</p>
                            <a href="@Url.Action("Index", "Senior")" class="btn btn-primary">
                                <i class="fas fa-user-plus me-1"></i> Manage Seniors
                            </a>
                        </div>
                    }
                </div>
            </div>

            <!-- Export Card -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="mb-0"><i class="fas fa-download me-2 text-primary"></i>Export Options</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <button class="btn btn-outline-success w-100" onclick="exportAttendance('Present')">
                                <i class="fas fa-file-excel me-2"></i>Export Present List
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-danger w-100" onclick="exportAttendance('Absent')">
                                <i class="fas fa-file-excel me-2"></i>Export Absent List
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-primary w-100" onclick="exportAttendance('All')">
                                <i class="fas fa-file-excel me-2"></i>Export Full List
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let eventId = @eventDetails.Id;
        let token = $('input[name="__RequestVerificationToken"]').val();
        let autoRefreshEnabled = true;
        let refreshInterval;

        // Initialize Chart
        function initAttendanceChart() {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            const presentPercent = @((int)Math.Round((double)presentCount / Model.Count * 100));
            const absentPercent = @((int)Math.Round((double)absentCount / Model.Count * 100));
            const unmarkedPercent = @((int)Math.Round((double)unmarkedCount / Model.Count * 100));

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Present', 'Absent', 'Unmarked'],
                    datasets: [{
                        data: [presentPercent, absentPercent, unmarkedPercent],
                        backgroundColor: ['#28a745', '#dc3545', '#6c757d'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const label = context.label;
                                    return `${label}: ${value}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update stats after attendance change
        function updateStats() {
            // Recalculate counts from the table
            let present = 0, absent = 0, unmarked = 0;

            $('#attendanceTable tbody tr').each(function() {
                const status = $(this).data('status');
                if (status === 'Present') present++;
                else if (status === 'Absent') absent++;
                else unmarked++;
            });

            // Update display
            $('.display-4.text-success').text(present);
            $('.display-4.text-danger').text(absent);
            $('.display-4.text-secondary').text(unmarked);

            // Update capacity if applicable
            if (@(eventDetails.MaxCapacity.HasValue ? "true" : "false")) {
                const maxCapacity = @(eventDetails.MaxCapacity ?? 0);
                const percentage = maxCapacity > 0 ? Math.round((present / maxCapacity) * 100) : 0;

                $('.progress-bar').css('width', percentage + '%');
                $('.progress-bar').text(percentage + '%');
                $('.fw-medium span:first-child').text(`Capacity: ${present} / ${maxCapacity}`);
                $('.text-muted.ms-2').text(`(${percentage}%)`);

                // Update full badge
                const fullBadge = $('.badge.bg-danger');
                if (present >= maxCapacity) {
                    if (fullBadge.length === 0) {
                        $('.d-flex.justify-content-between.mb-2').append('<span class="badge bg-danger">Full</span>');
                    }
                } else {
                    fullBadge.remove();
                }
            }

            // Update pie chart
            if (@Model.Count > 0) {
                const total = present + absent + unmarked;
                const presentPercent = Math.round((present / total) * 100);
                const absentPercent = Math.round((absent / total) * 100);
                const unmarkedPercent = Math.round((unmarked / total) * 100);

                // Update legend
                $('.legend .d-flex:first-child .fw-medium').text(`${presentPercent}% (${present})`);
                $('.legend .d-flex:nth-child(2) .fw-medium').text(`${absentPercent}% (${absent})`);
                $('.legend .d-flex:last-child .fw-medium').text(`${unmarkedPercent}% (${unmarked})`);
            }
        }

        // Start auto-refresh
        function startAutoRefresh() {
            if (autoRefreshEnabled && !refreshInterval) {
                refreshInterval = setInterval(() => {
                    // Only refresh if page is visible
                    if (!document.hidden) {
                        updateStats();
                    }
                }, 2000); // Refresh every 2 seconds
            }
        }

        // Stop auto-refresh
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // Update selected count
        function updateSelectedCount() {
            let selected = $('.senior-checkbox:checked:not(:disabled)').length;
            $('#selectedCount').text(selected + ' selected');
            $('#bulkActionBtn').prop('disabled', selected === 0);
        }

        // Select All functionality
        $('#selectAll').on('change', function() {
            let isChecked = $(this).prop('checked');
            $('.senior-checkbox:not(:disabled)').prop('checked', isChecked);
            updateSelectedCount();
        });

        // Toggle select all visible
        $('#toggleSelectAll').on('change', function() {
            let isChecked = $(this).prop('checked');
            $('#attendanceTable tbody tr:visible .senior-checkbox:not(:disabled)').prop('checked', isChecked);
            updateSelectedCount();
        });

        // Individual checkbox change
        $(document).on('change', '.senior-checkbox', updateSelectedCount);

        // Search functionality
        $('#searchSeniors').on('keyup', function() {
            let search = $(this).val().toLowerCase();
            $('#attendanceTable tbody tr').each(function() {
                let text = $(this).text().toLowerCase();
                $(this).toggle(text.includes(search));
            });
            updateSelectedCount();
        });

        // Filter by zone
        $('#filterZone').on('change', filterTable);
        $('#filterBarangay').on('change', filterTable);
        $('#filterAttendance').on('change', filterTable);

        function filterTable() {
            let zone = $('#filterZone').val();
            let barangay = $('#filterBarangay').val();
            let status = $('#filterAttendance').val();

            $('#attendanceTable tbody tr').each(function() {
                let rowZone = $(this).data('zone').toString();
                let rowBarangay = $(this).data('barangay');
                let rowStatus = $(this).data('status');

                let show = true;

                if (zone && rowZone !== zone) {
                    show = false;
                }

                if (barangay && rowBarangay !== barangay) {
                    show = false;
                }

                if (status) {
                    if (status === "Unmarked" && rowStatus !== "Unmarked") {
                        show = false;
                    } else if (status !== "Unmarked" && rowStatus !== status) {
                        show = false;
                    }
                }

                $(this).toggle(show);
            });
            updateSelectedCount();
        }

        function markAttendance(seniorId, status) {
            const currentStatus = $(`tr[data-senior-id="${seniorId}"]`).data('status');

            // Prevent changing from Absent to Present
            if (currentStatus === "Absent" && status === "Present") {
                Swal.fire({
                    icon: 'error',
                    title: 'Cannot Change Status',
                    text: 'Cannot change from Absent to Present. Once marked Absent, it cannot be changed to Present.',
                    confirmButtonColor: '#dc3545'
                });
                return;
            }

            if (status === 'Absent') {
                Swal.fire({
                    title: 'Mark as Absent',
                    html: `Are you sure you want to mark this senior as <strong>Absent</strong>?<br>
                           <small class="text-muted">Note: Once marked Absent, cannot be changed to Present.</small>`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Mark Absent',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        performMarkAttendance(seniorId, status);
                    }
                });
            } else {
                performMarkAttendance(seniorId, status);
            }
        }

        function performMarkAttendance(seniorId, status) {
            $.ajax({
                url: '@Url.Action("MarkAttendance", "Event")',
                type: 'POST',
                data: {
                    id: eventId,
                    seniorId: seniorId,
                    status: status,
                    __RequestVerificationToken: token
                },
                beforeSend: function() {
                    $(`tr[data-senior-id="${seniorId}"] .btn`).prop('disabled', true);
                },
                success: function (response) {
                    if (response.success) {
                        // Update UI
                        let row = $(`tr[data-senior-id="${seniorId}"]`);
                        row.data('status', status);

                        // Update badge
                        let badge = row.find('.badge').last();
                        badge.removeClass('bg-success bg-danger bg-secondary')
                            .addClass(getAttendanceBadgeClass(status))
                            .text(status);

                        // Update row color
                        row.removeClass('table-success-light table-danger-light')
                            .addClass(status === 'Present' ? 'table-success-light' :
                                     status === 'Absent' ? 'table-danger-light' : '');

                        // Update buttons
                        let btnGroup = row.find('.btn-group');
                        if (status === 'Present') {
                            btnGroup.html(`
                                <button class="btn btn-success" disabled title="Already Present">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-outline-secondary" disabled title="Cannot change from Present">
                                    <i class="fas fa-lock"></i>
                                </button>
                            `);
                            row.find('.senior-checkbox').prop('disabled', true).prop('checked', false);
                        } else if (status === 'Absent') {
                            btnGroup.html(`
                                <button class="btn btn-outline-secondary" disabled title="Cannot change from Absent to Present">
                                    <i class="fas fa-lock"></i>
                                </button>
                                <button class="btn btn-danger" disabled title="Already Absent">
                                    <i class="fas fa-times"></i>
                                </button>
                            `);
                            row.find('.senior-checkbox').prop('disabled', true).prop('checked', false);
                        }

                        // Update counters and stats
                        updateStats();
                        updateSelectedCount();

                        // Show success message
                        showToast('success', response.message);

                        // Start auto-refresh if not already running
                        startAutoRefresh();
                    } else {
                        showToast('error', response.message);
                        $(`tr[data-senior-id="${seniorId}"] .btn`).prop('disabled', false);
                    }
                },
                error: function (xhr, status, error) {
                    showToast('error', 'Failed to mark attendance: ' + error);
                    $(`tr[data-senior-id="${seniorId}"] .btn`).prop('disabled', false);
                }
            });
        }

        function bulkMarkAttendance() {
            let seniorIds = [];
            $('.senior-checkbox:checked:not(:disabled)').each(function() {
                seniorIds.push($(this).val());
            });

            if (seniorIds.length === 0) {
                showToast('warning', 'Please select at least one senior.');
                return;
            }

            let status = $('#bulkAction').val();

            Swal.fire({
                title: 'Bulk Mark Attendance',
                html: `Are you sure you want to mark <strong>${seniorIds.length}</strong> selected senior(s) as <strong>${status}</strong>?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: status === 'Present' ? '#28a745' : '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: `Mark as ${status}`,
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    return $.ajax({
                        url: '@Url.Action("BulkMarkAttendance", "Event")',
                        type: 'POST',
                        traditional: true,
                        data: {
                            id: eventId,
                            seniorIds: seniorIds,
                            status: status,
                            __RequestVerificationToken: token
                        }
                    });
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    if (result.value.success) {
                        // Reload page to update all data
                        location.reload();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: result.value.message
                        });
                    }
                }
            });
        }

        function markAllUnmarkedAsPresent() {
            let unmarkedIds = [];
            $('tr[data-status="Unmarked"]').each(function() {
                unmarkedIds.push($(this).data('senior-id'));
            });

            if (unmarkedIds.length === 0) {
                showToast('info', 'All seniors are already marked.');
                return;
            }

            Swal.fire({
                title: 'Mark All Unmarked',
                html: `Are you sure you want to mark <strong>${unmarkedIds.length}</strong> unmarked senior(s) as <strong>Present</strong>?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Mark All',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    return $.ajax({
                        url: '@Url.Action("BulkMarkAttendance", "Event")',
                        type: 'POST',
                        traditional: true,
                        data: {
                            id: eventId,
                            seniorIds: unmarkedIds,
                            status: 'Present',
                            __RequestVerificationToken: token
                        }
                    });
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    if (result.value.success) {
                        location.reload();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: result.value.message
                        });
                    }
                }
            });
        }

        function clearAllAttendance() {
            let markedIds = [];
            $('tr[data-status="Present"], tr[data-status="Absent"]').each(function() {
                markedIds.push($(this).data('senior-id'));
            });

            if (markedIds.length === 0) {
                showToast('info', 'No attendance records to clear.');
                return;
            }

            Swal.fire({
                title: 'Clear All Attendance',
                html: `<p>Are you sure you want to clear all attendance records?</p>
                       <p class="text-danger"><strong>This will remove ${markedIds.length} attendance records!</strong></p>
                       <p class="text-muted small">This action cannot be undone.</p>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Clear All',
                cancelButtonText: 'Cancel',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("ClearAllAttendance", "Event")',
                        type: 'POST',
                        data: {
                            id: eventId,
                            __RequestVerificationToken: token
                        },
                        success: function(response) {
                            if (response.success) {
                                location.reload();
                            } else {
                                showToast('error', response.message);
                            }
                        },
                        error: function(xhr, status, error) {
                            showToast('error', 'Failed to clear attendance: ' + error);
                        }
                    });
                }
            });
        }

        function exportAttendance(filter) {
            let data = [];
            let fileName = `Event_${eventId}_Attendance_${filter}_${new Date().toISOString().slice(0,10)}.xlsx`;

            // Add event information
            data.push(['Event Attendance Report']);
            data.push(['Event:', '@eventDetails.EventTitle']);
            data.push(['Date:', '@eventDetails.EventDate.ToString("MMMM dd, yyyy")']);
            data.push(['Time:', '@eventDetails.TimeFormatted']);
            data.push(['Location:', '@eventDetails.EventLocation']);
            data.push(['Organizer:', '@eventDetails.OrganizedBy']);
            data.push(['']);
            data.push(['Senior Attendance List']);
            data.push(['Senior ID', 'Last Name', 'First Name', 'Middle Initial', 'Zone', 'Barangay', 'Age', 'Gender', 'Attendance Status']);

            // Filter rows based on selection
            let rows = [];
            if (filter === 'All') {
                rows = $('#attendanceTable tbody tr');
            } else if (filter === 'Present') {
                rows = $('#attendanceTable tbody tr[data-status="Present"]');
            } else if (filter === 'Absent') {
                rows = $('#attendanceTable tbody tr[data-status="Absent"]');
            }

            rows.each(function() {
                let cells = $(this).find('td');
                let seniorId = $(cells[1]).text().trim();
                let nameParts = $(cells[2]).find('.fw-medium').text().split(',');
                let lastName = nameParts[0].trim();
                let firstName = nameParts.length > 1 ? nameParts[1].trim().split(' ')[0] : '';
                let middleInitial = $(cells[2]).find('small').text().replace('.', '').trim();
                let zone = $(cells[3]).text().replace('Zone ', '').trim();
                let barangay = $(cells[4]).text().trim();
                let age = $(cells[5]).text().trim();
                let gender = $(cells[6]).text().trim();
                let status = $(this).data('status');

                data.push([seniorId, lastName, firstName, middleInitial, zone, barangay, age, gender, status]);
            });

            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Set column widths
            const wscols = [
                {wch: 12}, // Senior ID
                {wch: 15}, // Last Name
                {wch: 15}, // First Name
                {wch: 5},  // Middle Initial
                {wch: 5},  // Zone
                {wch: 15}, // Barangay
                {wch: 5},  // Age
                {wch: 8},  // Gender
                {wch: 15}  // Status
            ];
            ws['!cols'] = wscols;

            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Attendance");

            // Download file
            XLSX.writeFile(wb, fileName);

            showToast('success', `Exported ${rows.length} records to ${fileName}`);
        }

        function getAttendanceBadgeClass(status) {
            switch(status) {
                case 'Present': return 'bg-success';
                case 'Absent': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function showToast(icon, message) {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer);
                    toast.addEventListener('mouseleave', Swal.resumeTimer);
                }
            });

            Toast.fire({
                icon: icon,
                title: message
            });
        }

        // Initialize on page load
        $(document).ready(function() {
            updateSelectedCount();
            initAttendanceChart();
            startAutoRefresh();

            // Check if attendance has changed since page load
            @if (TempData["AttendanceUpdated"] != null)
            {
                    <text>
                    showToast('success', '@TempData["AttendanceUpdated"]');
                    </text>
            }

            // Stop auto-refresh when page is hidden
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    stopAutoRefresh();
                } else {
                    startAutoRefresh();
                }
            });

            // Stop auto-refresh when window is closed
            window.addEventListener('beforeunload', function() {
                stopAutoRefresh();
            });
        });
    </script>

    <style>
        .bg-pink-light {
            background-color: #f8d7da !important;
            color: #721c24;
        }

        .table-success-light {
            background-color: rgba(40, 167, 69, 0.05) !important;
        }

        .table-danger-light {
            background-color: rgba(220, 53, 69, 0.05) !important;
        }

        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: #f8f9fa;
        }

        .avatar-circle-sm {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 500;
        }

        .color-indicator {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .legend .d-flex {
            padding: 4px 0;
        }

        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.03);
        }

        .progress {
            background-color: #e9ecef;
            border-radius: 4px;
        }

        .progress-bar {
            border-radius: 4px;
            font-size: 12px;
            line-height: 8px;
        }

        .card {
            border-radius: 8px;
        }

        .form-control, .form-select {
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .btn {
            border-radius: 6px;
        }

        .badge {
            border-radius: 4px;
            font-weight: 500;
        }
    </style>
}