@{
    ViewData["Title"] = "";
    var stats = ViewBag.DashboardStats as SeniorManagement.Controllers.DashboardStatistics;
    var activities = ViewBag.RecentActivities as List<SeniorManagement.Models.ActivityLog>;
    var isAdmin = ViewBag.IsAdmin as bool? ?? false;
}

<div class="container-fluid px-0">
    <!-- Welcome Header with Notification Bell -->
    <div class="row mx-0 mb-4">
        <div class="col-12 px-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h3>
                <div class="d-flex align-items-center gap-2">
                    <!-- Notification Bell -->
                    <div class="dropdown">
                        <button class="btn btn-light position-relative dropdown-toggle" type="button"
                                id="notificationDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-bell"></i>
                            <span id="notificationBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">
                                0
                            </span>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end p-0" aria-labelledby="notificationDropdown" style="min-width: 350px; max-width: 400px;">
                            <div class="card border-0">
                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="fas fa-bell me-2"></i>Notifications</h6>
                                    <div class="d-flex gap-2">
                                        <button id="markAllAsRead" class="btn btn-sm btn-light" title="Mark all as read">
                                            <i class="fas fa-check-double"></i>
                                        </button>
                                        <button id="refreshNotifications" class="btn btn-sm btn-light" title="Refresh">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                                    <div id="notificationsList" class="list-group list-group-flush">
                                        <!-- Notifications will be loaded here -->
                                        <div class="list-group-item text-center py-4 text-muted">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-2 mb-0">Loading notifications...</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent border-top-0 text-center">
                                    <a href="#" id="viewAllNotifications" class="btn btn-sm btn-outline-primary w-100">
                                        <i class="fas fa-external-link-alt me-1"></i> View All Notifications
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button id="refreshBtn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-sync-alt me-1"></i> Refresh
                    </button>

                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
                        <label class="form-check-label small" for="autoRefreshToggle">Auto-refresh</label>
                    </div>
                </div>
            </div>

            <div class="alert alert-info mb-0">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="flex-grow-1">
                        <h5 class="mb-1">
                            <i class="fas fa-user-circle me-2"></i>Welcome, @ViewBag.Name!
                        </h5>
                        <p class="mb-0 small">
                            Logged in as <strong>@ViewBag.UserRole</strong>
                            @if (isAdmin)
                            {
                                <span class="badge bg-danger ms-2">Administrator</span>
                            }
                        </p>
                    </div>
                    <div class="text-end">
                        <div id="currentTime" class="small text-muted">@DateTime.Now.ToString("dddd, MMMM dd, yyyy HH:mm:ss")</div>
                        <div id="systemStatus" class="badge bg-success small">Online</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mx-0">
        <!-- ... (keep your existing stat cards) ... -->
    </div>

    <!-- Second Row of Stats -->
    <div class="row mx-0">
        <!-- ... (keep your existing stat cards) ... -->
    </div>

    <!-- Charts and Quick Actions -->
    <div class="row mx-0">
        <div class="col-12 col-lg-8 px-2 mb-3">
            <div class="card shadow">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Gender Distribution</h6>
                    <div class="small text-muted" id="lastUpdated">Updated: Just now</div>
                </div>
                <div class="card-body">
                    <div class="chart-pie">
                        <canvas id="genderChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-4 px-2 mb-3">
            <div class="card shadow">
                <div class="card-header py-2">
                    <h6 class="m-0 font-weight-bold text-primary">Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        @if (isAdmin)
                        {
                            <div class="col-6">
                                <a href="@Url.Action("ManageUsers", "Admin")" class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center p-2">
                                    <i class="fas fa-users-cog fa-2x mb-2"></i>
                                    <span class="small text-center">Manage Users</span>
                                </a>
                            </div>
                            <div class="col-6">
                                <a href="@Url.Action("Dashboard", "Admin")" class="btn btn-outline-warning w-100 h-100 d-flex flex-column align-items-center justify-content-center p-2">
                                    <i class="fas fa-tachometer-alt fa-2x mb-2"></i>
                                    <span class="small text-center">Admin Dashboard</span>
                                </a>
                            </div>
                        }
                        else
                        {
                            <div class="col-6">
                                <a href="@Url.Action("Index", "Profile")" class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center p-2">
                                    <i class="fas fa-user-cog fa-2x mb-2"></i>
                                    <span class="small text-center">My Profile</span>
                                </a>
                            </div>
                        }

                        <div class="col-6">
                            <a href="@Url.Action("Index", "Senior")" class="btn btn-outline-success w-100 h-100 d-flex flex-column align-items-center justify-content-center p-2">
                                <i class="fas fa-user-friends fa-2x mb-2"></i>
                                <span class="small text-center">Senior Records</span>
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="@Url.Action("Index", "Event")" class="btn btn-outline-info w-100 h-100 d-flex flex-column align-items-center justify-content-center p-2">
                                <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                                <span class="small text-center">Events</span>
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="@Url.Action("Index", "Report")" class="btn btn-outline-warning w-100 h-100 d-flex flex-column align-items-center justify-content-center p-2">
                                <i class="fas fa-chart-bar fa-2x mb-2"></i>
                                <span class="small text-center">Reports</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activities Full Width -->
    <div class="row mx-0">
        <div class="col-12 px-2 mb-3">
            <div class="card shadow">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="m-0 font-weight-bold text-primary">Recent Activities</h6>
                        <small class="text-muted">Live updates enabled</small>
                    </div>
                    <div class="d-flex gap-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="activitiesLiveUpdate" checked>
                            <label class="form-check-label small" for="activitiesLiveUpdate">Live</label>
                        </div>
                        <a href="@Url.Action("Index", "ActivityLog")" class="btn btn-sm btn-primary">View All</a>
                    </div>
                </div>
                <div class="card-body p-0" id="recentActivitiesContainer">
                    <div class="list-group list-group-flush" id="recentActivitiesList">
                        <!-- Activities will be populated via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .notification-item {
            border-left: 4px solid;
            transition: all 0.2s;
        }

            .notification-item.unread {
                background-color: rgba(13, 110, 253, 0.05);
                border-left-color: #0d6efd;
            }

            .notification-item.read {
                background-color: transparent;
                border-left-color: transparent;
            }

            .notification-item:hover {
                background-color: rgba(0, 0, 0, 0.02);
            }

            .notification-item.info {
                border-left-color: #0dcaf0;
            }

            .notification-item.success {
                border-left-color: #198754;
            }

            .notification-item.warning {
                border-left-color: #ffc107;
            }

            .notification-item.danger {
                border-left-color: #dc3545;
            }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.7rem;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-time {
            font-size: 0.75rem;
            color: #6c757d;
        }

        .notification-dropdown {
            min-width: 350px;
            max-width: 400px;
        }
    </style>
}

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let activityHubConnection = null;
        let isActivitiesLive = true;
        let isAutoRefresh = true;
        let genderChart = null;
        let autoRefreshTimer = null;
        let notificationRefreshTimer = null;

        // Notification System Functions
        async function loadNotifications() {
            try {
                const response = await fetch('@Url.Action("GetNotifications", "Home")');
                const data = await response.json();

                if (data.success) {
                    updateNotificationsUI(data.notifications, data.unreadCount);
                }
            } catch (error) {
                console.error("Error loading notifications:", error);
            }
        }

        function updateNotificationsUI(notifications, unreadCount) {
            const container = $('#notificationsList');
            const badge = $('#notificationBadge');

            // Update badge
            if (unreadCount > 0) {
                badge.text(unreadCount).show();
            } else {
                badge.hide();
            }

            // Update notifications list
            container.empty();

            if (!notifications || notifications.length === 0) {
                container.html(`
                    <div class="list-group-item text-center py-4 text-muted">
                        <i class="fas fa-bell-slash fa-2x mb-3"></i>
                        <p class="mb-0">No notifications yet</p>
                    </div>
                `);
                return;
            }

            notifications.forEach(notification => {
                const notificationClass = notification.isRead ? 'read' : 'unread';
                const notificationHtml = `
                    <div class="list-group-item notification-item ${notificationClass} ${notification.type}" data-id="${notification.id}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1 me-2">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-bell me-2 text-${notification.type}"></i>
                                    <strong class="text-truncate">${notification.title}</strong>
                                </div>
                                <p class="small mb-1 text-truncate">${notification.message}</p>
                                <small class="notification-time">${notification.timeAgo}</small>
                            </div>
                            <div class="d-flex flex-column gap-1">
                                ${!notification.isRead ? `
                                    <button class="btn btn-sm btn-outline-success mark-as-read" title="Mark as read">
                                        <i class="fas fa-check"></i>
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm btn-outline-danger delete-notification" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        ${notification.url ? `
                            <div class="mt-2">
                                <a href="${notification.url}" class="btn btn-sm btn-outline-primary w-100">
                                    <i class="fas fa-external-link-alt me-1"></i> View Details
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
                container.append(notificationHtml);
            });

            // Add event listeners to new notification buttons
            $('.mark-as-read').click(function(e) {
                e.stopPropagation();
                const notificationId = $(this).closest('.notification-item').data('id');
                markNotificationAsRead(notificationId);
            });

            $('.delete-notification').click(function(e) {
                e.stopPropagation();
                const notificationId = $(this).closest('.notification-item').data('id');
                deleteNotification(notificationId);
            });

            // Make notification items clickable
            $('.notification-item').click(function(e) {
                if (!$(e.target).closest('button').length) {
                    const notificationId = $(this).data('id');
                    markNotificationAsRead(notificationId);

                    // Navigate to URL if exists
                    const url = $(this).find('a').attr('href');
                    if (url) {
                        window.location.href = url;
                    }
                }
            });
        }

        async function markNotificationAsRead(id) {
            try {
                const response = await fetch('@Url.Action("MarkNotificationAsRead", "Home")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: id })
                });

                const data = await response.json();
                if (data.success) {
                    loadNotifications(); // Reload notifications
                }
            } catch (error) {
                console.error("Error marking notification as read:", error);
            }
        }

        async function markAllNotificationsAsRead() {
            try {
                const response = await fetch('@Url.Action("MarkAllNotificationsAsRead", "Home")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                if (data.success) {
                    loadNotifications(); // Reload notifications
                    showNotification('All notifications marked as read', 'success');
                }
            } catch (error) {
                console.error("Error marking all notifications as read:", error);
            }
        }

        async function deleteNotification(id) {
            if (!confirm('Are you sure you want to delete this notification?')) return;

            try {
                const response = await fetch('@Url.Action("DeleteNotification", "Home")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: id })
                });

                const data = await response.json();
                if (data.success) {
                    loadNotifications(); // Reload notifications
                    showNotification('Notification deleted', 'success');
                }
            } catch (error) {
                console.error("Error deleting notification:", error);
            }
        }

        // Initialize SignalR for real-time updates
        async function initializeSignalR() {
            try {
                activityHubConnection = new signalR.HubConnectionBuilder()
                    .withUrl("/activityHub")
                    .withAutomaticReconnect({
                        nextRetryDelayInMilliseconds: retryContext => {
                            return Math.min(1000 * Math.pow(2, retryContext.previousRetryCount), 30000);
                        }
                    })
                    .build();

                // Listen for new activities
                activityHubConnection.on("ReceiveNewActivity", function (activity) {
                    console.log("New activity received:", activity);
                    if (isActivitiesLive) {
                        addActivityToList(activity);
                        updateLastUpdated();
                    }
                });

                // Listen for new notifications
                activityHubConnection.on("ReceiveNotification", function (notification) {
                    console.log("New notification received:", notification);
                    // Reload notifications when new one arrives
                    loadNotifications();
                    showToastNotification(notification.message, notification.type);
                });

                // Listen for connection events
                activityHubConnection.onreconnecting(error => {
                    console.log('SignalR reconnecting...', error);
                    updateSystemStatus('Reconnecting...', 'warning');
                });

                activityHubConnection.onreconnected(connectionId => {
                    console.log('SignalR reconnected. Connection ID:', connectionId);
                    updateSystemStatus('Online', 'success');
                    loadDashboardData();
                    loadNotifications();
                });

                await activityHubConnection.start();
                console.log("SignalR connected for dashboard.");

                // Join activity group
                await activityHubConnection.invoke("JoinActivityGroup");

                // Request initial data
                await activityHubConnection.invoke("RequestInitialData");

            } catch (err) {
                console.error("SignalR connection error:", err);
                updateSystemStatus('Offline (Polling)', 'warning');
                // Fallback to polling
                setupPolling();
            }
        }

        // Show toast notification
        function showToastNotification(message, type = 'info') {
            // Remove any existing toast
            $('.toast-notification').remove();

            const icon = {
                'info': 'fa-info-circle',
                'success': 'fa-check-circle',
                'warning': 'fa-exclamation-triangle',
                'danger': 'fa-exclamation-circle'
            }[type] || 'fa-info-circle';

            const toast = $(`
                <div class="toast-notification toast show align-items-center text-bg-${type} border-0 position-fixed"
                     role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas ${icon} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `);

            toast.css({
                top: '20px',
                right: '20px',
                zIndex: '9999'
            });

            $('body').append(toast);

            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.fadeOut(300, () => toast.remove());
            }, 5000);
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load statistics
                const statsResponse = await fetch('@Url.Action("GetDashboardStats", "Home")');
                const statsData = await statsResponse.json();

                if (statsData.success) {
                    updateDashboardStats(statsData.stats);
                }

                // Load recent activities
                await loadRecentActivities();

                // Update system status
                updateSystemStatus('Online', 'success');
                updateLastUpdated();

            } catch (error) {
                console.error("Error loading dashboard data:", error);
                updateSystemStatus('Error loading data', 'danger');
            }
        }

        // Update dashboard statistics
        function updateDashboardStats(stats) {
            // Update all stat cards
            $('#totalSeniors').text(stats.totalSeniors);
            $('#activeSeniors').text(stats.activeSeniors);
            $('#maleCount').text(stats.maleCount);
            $('#femaleCount').text(stats.femaleCount);
            $('#recentRegistrations').text(`+${stats.recentRegistrations} this week`);
            $('#upcomingEvents').text(stats.upcomingEvents);
            $('#totalUsers').text(stats.totalUsers);
            $('#activeUsers').text(stats.activeUsers);
            $('#pendingActions').text(stats.pendingActions || 0);

            // Update percentages
            const totalSeniors = stats.totalSeniors;
            const malePercentage = totalSeniors > 0 ? Math.round((stats.maleCount / totalSeniors) * 100 * 10) / 10 : 0;
            const femalePercentage = totalSeniors > 0 ? Math.round((stats.femaleCount / totalSeniors) * 100 * 10) / 10 : 0;

            $('#malePercentage').text(`${malePercentage}%`);
            $('#femalePercentage').text(`${femalePercentage}%`);

            // Update chart
            updateGenderChart(stats.maleCount, stats.femaleCount);
        }

        // Load recent activities
        async function loadRecentActivities() {
            try {
                const response = await fetch('@Url.Action("GetRecentActivitiesAjax", "Home")');
                const data = await response.json();

                if (data.success) {
                    updateActivitiesList(data.activities);
                }
            } catch (error) {
                console.error("Error loading activities:", error);
            }
        }

        // Update activities list
        function updateActivitiesList(activities) {
            const container = $('#recentActivitiesList');
            container.empty();

            if (!activities || activities.length === 0) {
                container.html(`
                    <div class="list-group-item text-center text-muted py-4">
                        <i class="fas fa-info-circle me-2"></i>No recent activities
                    </div>
                `);
                return;
            }

            activities.forEach(activity => {
                const timeAgo = getTimeAgo(activity.createdAt);
                const activityHtml = `
                    <div class="list-group-item activity-item" data-id="${activity.id}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="badge ${activity.userRole === 'Administrator' ? 'bg-danger' : 'bg-info'} me-2">
                                        ${activity.userName}
                                    </span>
                                    <small class="text-muted">${activity.action}</small>
                                </div>
                                ${activity.details ? `
                                    <small class="text-muted d-block">
                                        ${activity.details}
                                    </small>
                                ` : ''}
                            </div>
                            <small class="text-muted">${timeAgo}</small>
                        </div>
                    </div>
                `;
                container.append(activityHtml);
            });
        }

        // Add new activity to list
        function addActivityToList(activity) {
            const container = $('#recentActivitiesList');

            // Remove "no activities" message if present
            if (container.find('.text-center').length > 0) {
                container.empty();
            }

            const timeAgo = getTimeAgo(activity.createdAt);
            const activityHtml = `
                <div class="list-group-item activity-item new-activity" data-id="${activity.id}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <span class="badge ${activity.userRole === 'Administrator' ? 'bg-danger' : 'bg-info'} me-2">
                                    ${activity.userName}
                                </span>
                                <small class="text-muted">${activity.action}</small>
                            </div>
                            ${activity.details ? `
                                <small class="text-muted d-block">
                                    ${activity.details}
                                </small>
                            ` : ''}
                        </div>
                        <small class="text-muted">Just now</small>
                    </div>
                </div>
            `;

            // Add to top
            container.prepend(activityHtml);

            // Add highlight animation
            setTimeout(() => {
                $('.new-activity').removeClass('new-activity');
            }, 2000);

            // Keep only 10 items
            if (container.children().length > 10) {
                container.children().last().remove();
            }
        }

        // Gender Distribution Chart
        function initChart(maleCount, femaleCount) {
            var genderCtx = document.getElementById('genderChart').getContext('2d');

            genderChart = new Chart(genderCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Male', 'Female'],
                    datasets: [{
                        data: [maleCount, femaleCount],
                        backgroundColor: ['#4e73df', '#1cc88a'],
                        hoverBackgroundColor: ['#2e59d9', '#17a673'],
                        borderWidth: 2,
                        borderColor: '#ffffff',
                        hoverBorderColor: '#ffffff'
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    let value = context.raw || 0;
                                    let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    let percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            adjustChartSize();
        }

        function updateGenderChart(maleCount, femaleCount) {
            if (genderChart) {
                genderChart.data.datasets[0].data = [maleCount, femaleCount];
                genderChart.update();
            } else {
                initChart(maleCount, femaleCount);
            }
        }

        function adjustChartSize() {
            if (window.innerWidth < 768) {
                document.getElementById('genderChart').parentNode.style.height = '250px';
            } else {
                document.getElementById('genderChart').parentNode.style.height = '300px';
            }
            if (genderChart) {
                genderChart.resize();
            }
        }

        // Setup polling fallback
        function setupPolling() {
            // Load data initially
            loadDashboardData();
            loadNotifications();

            // Poll every 30 seconds if auto-refresh is enabled
            autoRefreshTimer = setInterval(() => {
                if (isAutoRefresh) {
                    loadDashboardData();
                }
            }, 30000);

            // Poll notifications every minute
            notificationRefreshTimer = setInterval(() => {
                loadNotifications();
            }, 60000);
        }

        // Update system status
        function updateSystemStatus(status, type) {
            const element = $('#systemStatus');
            element.text(status);
            element.removeClass('bg-success bg-warning bg-danger');
            element.addClass(`bg-${type}`);
        }

        // Update last updated time
        function updateLastUpdated() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            $('#lastUpdated').text(`Updated: ${timeString}`);
        }

        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            const dateString = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            $('#currentTime').text(`${dateString} ${timeString}`);
        }

        // Helper functions
        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);

            if (diffDay > 0) return `${diffDay}d ago`;
            if (diffHour > 0) return `${diffHour}h ago`;
            if (diffMin > 0) return `${diffMin}m ago`;
            if (diffSec > 0) return `${diffSec}s ago`;
            return 'Just now';
        }

        function showNotification(message, type = 'info') {
            // Remove any existing notification
            $('.notification-toast').remove();

            const notification = $(`
                <div class="notification-toast alert alert-${type} position-fixed">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                        <div>${message}</div>
                        <button type="button" class="btn-close ms-auto" onclick="$(this).parent().parent().remove()"></button>
                    </div>
                </div>
            `);

            notification.css({
                top: '20px',
                right: '20px',
                zIndex: '9999',
                minWidth: '300px'
            });

            $('body').append(notification);

            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.fadeOut(300, function() {
                    $(this).remove();
                });
            }, 3000);
        }

        // Initialize when page loads
        $(document).ready(function() {
            // Initialize SignalR
            initializeSignalR();

            // Load initial data
            loadDashboardData();
            loadNotifications();

            // Initialize chart
            updateGenderChart(@stats?.MaleCount ?? 0, @stats?.FemaleCount ?? 0);

            // Update current time every second
            setInterval(updateCurrentTime, 1000);
            updateCurrentTime();

            // Update chart on window resize
            $(window).resize(adjustChartSize);

            // Refresh button
            $('#refreshBtn').click(function() {
                const btn = $(this);
                const originalHTML = btn.html();

                btn.html('<i class="fas fa-spinner fa-spin me-1"></i> Refreshing...');
                btn.prop('disabled', true);

                loadDashboardData().finally(() => {
                    setTimeout(() => {
                        btn.html(originalHTML);
                        btn.prop('disabled', false);
                        showNotification('Dashboard refreshed successfully!', 'success');
                    }, 500);
                });
            });

            // Refresh notifications button
            $('#refreshNotifications').click(function(e) {
                e.stopPropagation();
                loadNotifications();
                showNotification('Notifications refreshed', 'success');
            });

            // Mark all as read button
            $('#markAllAsRead').click(function(e) {
                e.stopPropagation();
                markAllNotificationsAsRead();
            });

            // View all notifications
            $('#viewAllNotifications').click(function(e) {
                e.preventDefault();
                // You can implement a full notifications page here
                alert('Full notifications page would open here');
            });

            // Toggle auto-refresh
            $('#autoRefreshToggle').change(function() {
                isAutoRefresh = this.checked;
                if (isAutoRefresh && !activityHubConnection) {
                    setupPolling();
                } else if (!isAutoRefresh) {
                    if (autoRefreshTimer) {
                        clearInterval(autoRefreshTimer);
                        autoRefreshTimer = null;
                    }
                    if (notificationRefreshTimer) {
                        clearInterval(notificationRefreshTimer);
                        notificationRefreshTimer = null;
                    }
                }
            });

            // Toggle activities live updates
            $('#activitiesLiveUpdate').change(function() {
                isActivitiesLive = this.checked;
            });
        });

        // Cleanup on page unload
        $(window).on('beforeunload', function() {
            if (activityHubConnection) {
                activityHubConnection.stop();
            }
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
            if (notificationRefreshTimer) {
                clearInterval(notificationRefreshTimer);
            }
        });
    </script>
}